DROP PROCEDURE IF EXISTS UpdateBestseller;
DELIMITER $$
CREATE PROCEDURE UpdateBestseller()
BEGIN
    DECLARE BOOKRENTS, DAYS, BK_ID INT;
    DECLARE RENTSPERMONTH INT;
    DECLARE ISBESTSELLER BOOLEAN DEFAULT FALSE;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;

    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
        FETCH ALL_BOOKS INTO BK_ID;
        IF (FINISHED = 0) THEN
            SELECT COUNT(*) FROM RENTS
                WHERE BOOK_ID = BK_ID INTO BOOKRENTS;

            SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) FROM RENTS
                WHERE BOOK_ID = BK_ID INTO DAYS;

            SET RENTSPERMONTH = BOOKRENTS/DAYS * 30;

            IF RENTSPERMONTH > 2 THEN
                SET ISBESTSELLER = TRUE;
                ELSE SET ISBESTSELLER = FALSE;
            end if;
            UPDATE BOOKS SET BESTSELLER = ISBESTSELLER
            WHERE BOOK_ID = BK_ID;
            COMMIT;
        end if;
    end while;
    CLOSE ALL_BOOKS;
end $$
DELIMITER ;

CALL UpdateBestseller();
